= Maven实战
pxzxj; pudge.zxj@gmail.com; 2022/06/09

本文根据国内Maven专家许晓斌在InfoQ连载的系列文章 https://www.infoq.cn/profile/DC5848403A32D1/publish/all[Maven实战]以及个人使用经验整理而成，主要介绍Maven的日常使用方法和技巧

== 坐标规划

坐标是 Maven 的核心，正确的坐标不但使项目结构直观清晰，也给日常依赖管理带来极大便利，下文结合Spring的坐标介绍一种合理的坐标规划方式

=== groupId

Spring项目的groupId有两种形式，一种是 `org.springframework`，Spring Framework的依赖都在此groupId下，例如spring-core、spring-beans、spring-context等，另一种是包含具体的项目名的如 `org.springframework.boot` 表示Spring Boot项目，`org.springframework.security` 表示Spring Security项目。可以发现使用 `org.springframework` 的都是些非常基础的模块，这些依赖被广泛使用在其它项目中。

一个企业中一般都有多个业务项目，这些项目也可以参考Spring项目进行groupId规划，不同项目间公共的依赖使用反写的企业域名作为groupId例如 `com.baidu`，具体业务项目的groupId再加上项目名称例如 `com.baidu.tieba`

=== artifactId

artifactId同样可以按照基础模块和具体项目来分类，Spring项目中的基础模块包括 `spring-core`、`spring-beans`等，而具体项目则包括 `spring-security-core`、`spring-security-config` 等，可以发现artifactId定义的规律，首先是企业名称，紧接着是项目名，最后一部分是项目下子项目名称，如果是基础模块则省略项目名。

可以发现项目名既出现在了groupId中也出现在了artifactId中，貌似存在冗余，但这是有必要的。groupId中包含项目名不难理解，可以对同一项目下的多个子项目进行进一步分组，而artifactId包含的项目名则是考虑了项目打包后的问题，因为项目打包后生成的文件只包含artifactId，如果artifactId中没有项目名，那么不同项目的同一名称的子项目打包后生成的文件非常容易混淆。假设Spring Security和Spring Session都有一个子项目core，对应的坐标是 `org.springframework.security:core:1.0` 和 `org.springframework.session:core:2.0`，那么最终打包的后分别生成了core-1.0.jar和core-2.0.jar，这样的两个文件显然容易混淆，若是加上了项目名变成spring-security-core-1.0.jar和spring-session-core-2.0.jar就清楚多了


=== version

Spring团队在2020年的一篇博文 https://spring.io/blog/2020/04/30/updates-to-spring-versions#project-module-version-changes[Updates to Spring Versions]中介绍了Spring项目的版本约定，简而言之，Spring项目的版本格式为 `MAJOR.MINOR.PATCH[-MODIFIER]` 其中各字段意义如下

[horizontal]
MAJOR  :: 增加时表示巨大变更，例如即将到来的Spring Framework 6就新增非常多新特性，并且Java版本要求也从上个版本的Java 8升级为Java 17
MINOR  :: 增加时表示一小部分特性变更
PATCH  :: 增加时表示小的补丁变更
MODIFIER  ::  可选的修饰符表达额外信息，Spring项目使用M、RC、SNAPSHOT表示发布的不同阶段例如2.4.0-M1，正式发布时MODIFIER为空例如2.4.0

实际的项目中可以参考Spring的版本号约定结合项目现状制定版本号规则，例如一些小型项目可以只保留 `MAJOR` 和 `MINOR` 版本号

=== classifier

Classifier 可能是最容易被忽略的 Maven 特性，但它确实非常重要。设想这样一个情况，有一个 jar 项目，就说是dog-cli-1.0.jar吧，运行它用户就能在命令行上画一只小狗出来。现在用户的要求是希望你能提供一个 zip 包，里面不仅包含这个可运行的 jar，还得包含源代码和文档，换句话说，这是比较正式的分发包。这个文件名应该是怎样的呢？dog-cli-1.0.zip？不够清楚，仅仅从扩展名很难分辨什么是 Maven 默认生成的构件，什么是额外配置生成分发包。如果能是dog-cli-1.0-dist.zip就最好了。这里的 dist 就是 classifier，默认 Maven 只生成一个构件，我们称之为主构件，那希望 Maven 生成其他附属构件的时候，就能用上 classifier。常见的 classifier 还有如dog-cli-1.0-sources.jar表示源码包，dog-cli-1.0-javadoc.jar表示 JavaDoc 包等等。制作 classifier 的方式多种多样，其中最重要的一种是使用 http://maven.apache.org/plugins/maven-assembly-plugin/[Maven Assembly Plugin]。

== POM重构







== 打包的技巧





== 测试






== 插件




== 私服

maven私服用于管理公司内部使用的jar包，本次maven私服使用Jforg Artifactory社区版搭建

=== 下载依赖
下载依赖需要配置私服地址，有两种配置方式

==== 项目配置

项目的 `pom.xml` 添加下面的私服信息即可

[source,xml,subs="verbatim"]
----
<project>
...
    <repositories>
        <repository>
            <id>local-release</id>
            <url>http://maven.baidu.com/artifactory/libs-release-local</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>local-snapshot</id>
            <url>http://maven.baidu.com/artifactory/libs-snapshot-local</url>
            <releases>
                <enabled>false</enabled>
            </releases>
        </repository>
    </repositories>
...
</project>
----

==== 全局配置
在maven的 `setting.xml` 配置文件中添加如下内容

[source,xml,subs="verbatim"]
----
<settings>
...
<profiles>
    <profile>
      <id>baidu-repo</id>
      <repositories>
        <repository>
          <id>baidu-release</id>
          <name>baidu Release Repo</name>
          <url>http://maven.baidu.com/artifactory/libs-release-local</url>
          <layout>default</layout>
        </repository>
        <repository>
          <id>baidu-snapshot</id>
          <name>baidu Snapshot Repo</name>
          <url>http://maven.baidu.com/artifactory/libs-snapshot-local</url>
          <layout>default</layout>
        </repository>
      </repositories>
    </profile>
</profiles>
...
</settings>
----
配置说明参考 https://maven.apache.org/guides/mini/guide-multiple-repositories.html[maven官方站点]

=== 上传依赖
使用 `maven deploy` 可以将项目内部或者公司内部使用的jar包部署到私服供其它开发下载使用，部署前需要配置私服仓库位置及认证信息，配置方式有如下两种，任选其一即可

==== distributionManagement配置

在项目的 `pom.xml` 文件中添加如下内容
[source,xml,subs="verbatim"]
----
<project>
...
    <distributionManagement>
        <repository>
            <id>baidu-release</id>
            <url>http://maven.baidu.com/artifactory/libs-release-local</url>
        </repository>
        <snapshotRepository>
            <id>baidu-snapshot</id>
            <url>http://maven.baidu.com/artifactory/libs-snapshot-local</url>
        </snapshotRepository>
    </distributionManagement>
...
</project>

----

在maven的 `settings.xml` 文件中添加如下内容，id必须与distributionManagement配置中repository的id，username和password为私服认证的用户名密码
[source,xml,subs="verbatim"]
----
<settings>
...
  <servers>
    <server>
      <id>baidu-release</id>
      <username>user</username>
      <password>pwd</password>
    </server>
    <server>
      <id>baidu-snapshot</id>
      <username>user</username>
      <password>pwd</password>
    </server>
  </servers>
...
</settings>
----

更多内容参考 https://www.jfrog.com/confluence/display/JFROG/Maven+Repository[Artifactory官方说明]

==== Artifactory插件配置

在项目的 `pom.xml` 添加如下内容
[source,xml,subs="verbatim"]
----
<project>
...
    <build>
        <plugins>
            <plugin>
                <groupId>org.jfrog.buildinfo</groupId>
                <artifactId>artifactory-maven-plugin</artifactId>
                <version>3.2.3</version>
                <executions>
                    <execution>
                        <id>build-info</id>
                        <goals>
                            <goal>publish</goal>
                        </goals>
                        <configuration>
                            <publisher>
                                <contextUrl>http://maven.baidu.com/artifactory</contextUrl>
                                <username>{{artifactory.username}}</username>
                                <password>{{artifactory.password}}</password>
                                <repoKey>libs-release-local</repoKey>
                                <snapshotRepoKey>libs-snapshot-local</snapshotRepoKey>
                                <excludePatterns>*-docs-*</excludePatterns>
                            </publisher>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
...
</project>
----

上述配置中的 `artifactory.username` 和 `artifactory.password` 代表私服认证的用户名密码，为了安全此处使用属性名的表示法，实际用户名密码的值需要在maven中进行配置，Intellij IDEA的配置方法如下


image::images/maven-runner-properties.jpg[]

更多内容参考 https://www.jfrog.com/confluence/display/JFROG/Maven+Artifactory+Plugin[插件官方说明]

== Gradle

